# 定时任务使用说明

## 概述

本项目集成了GoFrame的gcron定时任务功能，用于定期清理数据库中已禁用的LiteFlow链路数据。

## 功能特性

- **自动清理**: 定期删除`enable`字段为0的链路数据
- **可配置**: 支持通过配置文件自定义执行时间和频率
- **安全执行**: 使用软删除机制，避免误删重要数据
- **日志记录**: 详细记录清理任务的执行过程和结果

## 配置说明

### 配置文件位置

配置文件位于 `manifest/config/config.yaml`

### 配置项说明

```yaml
cron:
  cleanup:
    # 是否启用定时清理任务
    enable: true
    # 是否在启动时立即执行一次清理任务
    runOnStartup: true
    # cron表达式，定义执行时间
    expression: "0 0 2 * * *"
    # 清理任务执行超时时间（秒）
    timeout: 300
```

### Cron表达式格式

GoFrame使用6位cron表达式格式：`秒 分 时 日 月 周`

常用示例：
- `"0 0 2 * * *"` - 每天凌晨2点执行
- `"0 0 */6 * * *"` - 每6小时执行一次
- `"0 0 0 * * 0"` - 每周日凌晨执行
- `"0 30 9 * * 1-5"` - 工作日早上9:30执行

## 使用方法

### 1. 自动启动

定时任务会在应用启动时自动启动，无需手动干预。

### 2. 手动执行

如果需要立即执行清理任务，可以通过以下方式：

```go
// 在代码中调用
cronService := service.NewCronService()
err := cronService.ManualCleanup()
```

### 3. 禁用定时任务

在配置文件中设置 `enable: false` 即可禁用定时任务。

## 日志监控

定时任务的执行过程会记录详细的日志信息：

- 任务启动日志
- 执行开始和结束日志
- 清理记录数量统计
- 执行耗时统计
- 错误信息记录

## 注意事项

1. **数据安全**: 清理任务会物理删除已禁用的数据，请确保数据备份
2. **性能影响**: 大量数据清理时可能影响数据库性能，建议在低峰期执行
3. **超时设置**: 根据数据量大小合理设置超时时间
4. **监控告警**: 建议监控清理任务的执行状态和结果

## 故障排除

### 常见问题

1. **任务未启动**: 检查配置文件中的`enable`设置
2. **执行失败**: 查看日志中的错误信息，检查数据库连接
3. **超时错误**: 调整配置文件中的`timeout`值

### 日志位置

日志文件位置取决于GoFrame的日志配置，通常在：
- 控制台输出
- 日志文件（如果配置了文件输出）

## 扩展功能

如需添加其他定时任务，可以参考现有代码结构：

1. 在`CronService`中添加新的任务方法
2. 在`StartCleanupTask`中注册新的定时任务
3. 在配置文件中添加相应的配置项 